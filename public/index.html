    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Ganesh Puja 2025 Food Token Donation</title>
        <style>
            body {
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
              max-width: 480px;
              margin: 20px auto;
              padding: 15px;
              background: #fff8f0;
              color: #333;
              border-radius: 8px;
              box-shadow: 0 0 12px rgba(0,0,0,0.1);
            }
            h1 {
              text-align: center;
              color: #d35400;
              margin-bottom: 20px;
              font-weight: 700;
            }
            label {
              display: block;
              margin-top: 15px;
              font-weight: 600;
              color: #5d4037;
            }
            select, input[type=number], input[type=email] {
              padding: 10px;
              font-size: 1rem;
              width: 100%;
              border: 2px solid #d35400;
              border-radius: 6px;
              margin-top: 5px;
              box-sizing: border-box;
            }
            small {
              font-size: 0.85rem;
              color: #7d6e68;
            }
            fieldset {
              margin-top: 20px;
              border: 2px solid #d35400;
              border-radius: 8px;
              padding: 15px;
              background: #fff3e0;
            }
            legend {
              font-weight: 700;
              color: #bf360c;
              padding: 0 10px;
            }
            #totalAmount {
              margin-top: 15px;
              font-weight: 700;
              font-size: 1.1rem;
              color: #e65100;
            }
            button {
              cursor: pointer;
              font-size: 1rem;
              padding: 12px;
              margin-top: 20px;
              width: 48%;
              border-radius: 6px;
              border: none;
              color: white;
              font-weight: 700;
              display: inline-flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              transition: background-color 0.3s ease;
            }
            #payPhonePe {
              background-color: #3cba54;
            }
            #payPhonePe:hover {
              background-color: #2a7d39;
            }
            #payGPay {
              background-color: #4285f4;
            }
            #payGPay:hover {
              background-color: #2a5abf;
            }
            #qrFallback {
              margin-top: 30px;
              text-align: center;
              display: none;
            }
            #qrFallback p {
              font-style: italic;
              color: #795548;
            }
            footer {
              font-size: 0.85rem;
              color: #6d4c41;
              margin-top: 40px;
              text-align: center;
              border-top: 1px solid #d7ccc8;
              padding-top: 10px;
            }
            /* Banner */
            .banner {
              width: 100%;
              height: 120px;
              background-image: url('https://astromanch.com/public/storage/images/blog_2341754464197.webp');
              background-size: cover;
              background-position: center;
              border-radius: 8px;
              margin-bottom: 25px;
            }
        </style>
    </head>
    <body>
    <div class="banner" aria-label="Ganesh Puja 2025 banner"></div>

    <h1>Ganesh Puja 2025 Food Token Donation</h1>

    <form id="tokenForm">
        <label>
            Block No:
            <select id="blockNo" required>
                <option value="">Select</option>
                <option value="A1">A1</option>
                <option value="A2">A2</option>
                <option value="B1">B1</option>
                <option value="B2">B2</option>
            </select>
        </label>

        <label>
            Flat No:
            <input type="number" id="flatNo" min="1" required />
        </label>

        <label>
            Email:
            <input type="email" id="email" required />
        </label>

        <label>
            Donation Amount (Min ₹750):
            <input type="number" id="donation" min="750" value="750" />
        </label>
        <small>This contribution will be used towards the event only.</small>

        <fieldset>
            <legend>Day-wise Token Selection</legend>

            <label>
                Day 1 (27th Aug) @ ₹125 per token:
                <input type="number" id="day1Tokens" min="0" value="0" />
            </label>
            <small><em>Poori, Chole, Sooji Halwa (Satwik Food: All W/O Onion & Garlic)</em></small>

            <label>
                Day 2 (28th Aug) @ ₹115 per token:
                <input type="number" id="day2Tokens" min="0" value="0" />
            </label>
            <small><em>Lemon Rice, Sabji, Papad (Satwik Food: All W/O Onion & Garlic)</em></small>

            <label>
                Day 3 (29th Aug) @ ₹325 per token:
                <input type="number" id="day3Tokens" min="0" value="0" />
            </label>
            <small><em>Veg Cutlet/Aloo Tikki, Puri, Chole, Kadhai Paneer, Veg pulav/Jeera Rice, Dal Tadka, Sweet, Kheer/moong dal halwa, Fryums/pickle (Satwik Food: All W/O Onion & Garlic)</em></small>
        </fieldset>

        <div id="totalAmount">Total Amount: ₹750.00</div>

        <button type="button" id="payPhonePe" title="Pay with PhonePe">
            <img src="https://uxwing.com/wp-content/themes/uxwing/download/brands-and-social-media/phonepe-icon.png" alt="PhonePe Logo" width="24" height="24" />
            Pay with PhonePe
        </button>
        <button type="button" id="payGPay" title="Pay with Google Pay">
            <img src="https://uxwing.com/wp-content/themes/uxwing/download/brands-and-social-media/google-pay-icon.png" alt="Google Pay Logo" width="24" height="24" />
            Pay with GPay
        </button>

        <div id="qrFallback">
            <p>If payment app doesn’t open, scan this QR code with your UPI app:</p>
            <canvas id="qrCanvas"></canvas>
        </div>
    </form>

    <footer>
        QR code will be sent to your email ID, required for claim at event.<br />
        Each claim reduces your token count accordingly.
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script>
        const DAY1_PRICE = 125;
        const DAY2_PRICE = 115;
        const DAY3_PRICE = 325;

        const UPI_PA = "swadhinsoft-2@okaxis";
        const UPI_PN = "Swadhin Acharya";

        const blockEl = document.getElementById("blockNo");
        const flatEl = document.getElementById("flatNo");
        const emailEl = document.getElementById("email");
        const donationEl = document.getElementById("donation");
        const day1TokensEl = document.getElementById("day1Tokens");
        const day2TokensEl = document.getElementById("day2Tokens");
        const day3TokensEl = document.getElementById("day3Tokens");
        const totalAmountEl = document.getElementById("totalAmount");

        const payPhonePeBtn = document.getElementById("payPhonePe");
        const payGPayBtn = document.getElementById("payGPay");

        const qrFallbackDiv = document.getElementById("qrFallback");
        const qrCanvas = document.getElementById("qrCanvas");

        function calculateTotal() {
          let donation = Number(donationEl.value);
          if (donation < 750 || isNaN(donation)) {
            donation = 750;
            donationEl.value = donation;
          }

          const day1Tokens = Number(day1TokensEl.value) || 0;
          const day2Tokens = Number(day2TokensEl.value) || 0;
          const day3Tokens = Number(day3TokensEl.value) || 0;

          const totalTokensCost =
            day1Tokens * DAY1_PRICE +
            day2Tokens * DAY2_PRICE +
            day3Tokens * DAY3_PRICE;
          const total = donation + totalTokensCost;

          totalAmountEl.textContent = `Total Amount: ₹${total.toFixed(2)}`;
          return total;
        }

        function generateTokensSummary(day1Tokens, day2Tokens, day3Tokens) {
          return `Day1:${day1Tokens} tokens, Day2:${day2Tokens} tokens, Day3:${day3Tokens} tokens`;
        }

        function encodeNote(flat, tokensSummary) {
          return encodeURIComponent(`Ganesh Puja 2025 | Flat: ${flat} | ${tokensSummary}`);
        }

        function generateUpiLink(app, amount, flat, tokensSummary) {
          const baseParams = `pa=${UPI_PA}&pn=${encodeURIComponent(UPI_PN)}&am=${amount}&cu=INR&tn=${encodeNote(flat, tokensSummary)}`;
          switch (app) {
            case "phonepe":
              return `phonepe://pay?${baseParams}`;
            case "gpay":
              return `gpay://upi/pay?${baseParams}`;
            default:
              return `upi://pay?${baseParams}`;
          }
        }

    async function handlePay(app) {
      const block = blockEl.value;
      const flat = flatEl.value;
      const email = emailEl.value;
      if (!block || !flat || !email) {
        alert("Please fill all required fields (Block, Flat, Email)");
        return;
      }
      const donation = Number(donationEl.value) || 0;
      if (donation < 750) {
        alert("Minimum donation is ₹750");
        return;
      }
      const day1Tokens = Number(day1TokensEl.value) || 0;
      const day2Tokens = Number(day2TokensEl.value) || 0;
      const day3Tokens = Number(day3TokensEl.value) || 0;

      if (day1Tokens + day2Tokens + day3Tokens === 0) {
        alert("Please select at least one token for any day");
        return;
      }

      const flatNo = `${block}-${flat}`;
      const tokensSummary = generateTokensSummary(day1Tokens, day2Tokens, day3Tokens);
      const total = donation + day1Tokens * DAY1_PRICE + day2Tokens * DAY2_PRICE + day3Tokens * DAY3_PRICE;

      // Send data to backend to generate and email QR tokens
      const response = await fetch("/.netlify/functions/generate-tokens", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
  eventName: "Ganesh Puja 2025",
  blockNo: block,
  flatNo: flat,
  email: email,
  baseDonation: donation,
  extraDonation: 0,    // can be 0 or any extra if needed
  days: {
    "1": day1Tokens,
    "2": day2Tokens,
    "3": day3Tokens
  },
  totalAmount: total,
  paymentNote: `Ganesh Puja 2025 | Flat: ${block}-${flat} | Day1: ${day1Tokens} tokens, Day2: ${day2Tokens} tokens, Day3: ${day3Tokens} tokens`
})

      });

      const result = await response.json();
      if (!result.success) {
        alert("Error sending tokens email: " + (result.error || "Unknown error"));
        return;
      }

      // Open payment app via UPI link
      const upiLink = generateUpiLink(app, total.toFixed(2), flatNo, tokensSummary);
      qrFallbackDiv.style.display = "none";
      window.location.href = upiLink;

      // Show fallback QR code if payment app doesn't open within 2 seconds
      setTimeout(() => {
        qrFallbackDiv.style.display = "block";
        QRCode.toCanvas(qrCanvas, generateUpiLink(null, total.toFixed(2), flatNo, tokensSummary), function (error) {
          if (error) console.error(error);
        });
      }, 2000);

    }

    // Event listeners for inputs to recalc total amount dynamically
    donationEl.addEventListener("input", calculateTotal);
    day1TokensEl.addEventListener("input", calculateTotal);
    day2TokensEl.addEventListener("input", calculateTotal);
    day3TokensEl.addEventListener("input", calculateTotal);

    // Ensure donation min value on blur
    donationEl.addEventListener("blur", () => {
      let val = Number(donationEl.value);
      if (val < 750 || isNaN(val)) {
        donationEl.value = 750;
      }
      calculateTotal();
    });

    // Payment buttons event listeners
    payPhonePeBtn.addEventListener("click", () => handlePay("phonepe"));
    payGPayBtn.addEventListener("click", () => handlePay("gpay"));

    // Initial total calculation on page load
    calculateTotal();
    </script>
    </body>
    </html>