<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ganesh Puja 2025 Token Donation</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 480px; margin: 20px auto; padding: 10px; }
        label { display: block; margin-top: 15px; }
        input, select, button { padding: 8px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        fieldset { margin-top: 20px; }
        #totalAmount { font-weight: bold; margin-top: 10px; }
        #qrFallback { margin-top: 20px; display: none; text-align: center; }
        footer { font-size: 0.8rem; color: #666; margin-top: 40px; text-align: center; }
    </style>
</head>
<body>
<h1>Ganesh Puja 2025 Food Token Donation</h1>

<form id="tokenForm">
    <label>
        Block No:
        <select id="blockNo" required>
            <option value="">Select</option>
            <option value="A1">A1</option>
            <option value="A2">A2</option>
            <option value="B1">B1</option>
            <option value="B2">B2</option>
        </select>
    </label>

    <label>
        Flat No:
        <input type="number" id="flatNo" min="1" required />
    </label>

    <label>
        Email:
        <input type="email" id="email" required />
    </label>

    <label>
        Donation Amount (Min ₹750):
        <input type="number" id="donation" min="750" value="750" />
    </label>
    <small>This contribution will be used towards the event only.</small>

    <fieldset>
        <legend>Day-wise Token Selection</legend>

        <label>
            Day 1 (27th Aug) @ ₹125 per token:
            <input type="number" id="day1Tokens" min="0" value="0" />
        </label>

        <label>
            Day 2 (28th Aug) @ ₹150 per token:
            <input type="number" id="day2Tokens" min="0" value="0" />
        </label>
    </fieldset>

    <div id="totalAmount">Total Amount: ₹750</div>

    <button type="button" id="payPhonePe">Pay with PhonePe</button>
    <button type="button" id="payGPay">Pay with GPay</button>

    <div id="qrFallback">
        <p>If payment app doesn’t open, scan this QR code with your UPI app:</p>
        <canvas id="qrCanvas"></canvas>
    </div>
</form>

<footer>
    QR code will be sent to your email ID, required for claim at event.<br/>
    Each claim reduces your token count accordingly.
</footer>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
    const DAY1_PRICE = 125;
    const DAY2_PRICE = 150;
    const UPI_PA = "swadhinsoft-2@okaxis";
    const UPI_PN = "Swadhin Acharya";

    const blockEl = document.getElementById("blockNo");
    const flatEl = document.getElementById("flatNo");
    const emailEl = document.getElementById("email");
    const donationEl = document.getElementById("donation");
    const day1TokensEl = document.getElementById("day1Tokens");
    const day2TokensEl = document.getElementById("day2Tokens");
    const totalAmountEl = document.getElementById("totalAmount");

    const payPhonePeBtn = document.getElementById("payPhonePe");
    const payGPayBtn = document.getElementById("payGPay");

    const qrFallbackDiv = document.getElementById("qrFallback");
    const qrCanvas = document.getElementById("qrCanvas");

    function calculateTotal() {
      const donation = Number(donationEl.value) || 0;
      const day1Tokens = Number(day1TokensEl.value) || 0;
      const day2Tokens = Number(day2TokensEl.value) || 0;

      const totalTokensCost = day1Tokens * DAY1_PRICE + day2Tokens * DAY2_PRICE;
      const total = donation + totalTokensCost;

      totalAmountEl.textContent = `Total Amount: ₹${total.toFixed(2)}`;
      return total;
    }

    function encodeNote(flat, tokensSummary) {
      return encodeURIComponent(`Ganesh Puja 2025 | Flat: ${flat} | ${tokensSummary}`);
    }

    function generateUpiLink(app, amount, flat, tokensSummary) {
      const baseParams = `pa=${UPI_PA}&pn=${encodeURIComponent(UPI_PN)}&am=${amount}&cu=INR&tn=${encodeNote(flat, tokensSummary)}`;
      switch (app) {
        case "phonepe":
          return `phonepe://pay?${baseParams}`;
        case "gpay":
          return `gpay://upi/pay?${baseParams}`;
        default:
          return `upi://pay?${baseParams}`;
      }
    }

    function generateTokensSummary(day1Tokens, day2Tokens) {
      return `Day1:${day1Tokens} tokens, Day2:${day2Tokens} tokens`;
    }

    function handlePay(app) {
      const block = blockEl.value;
      const flat = flatEl.value;
      const email = emailEl.value;
      if (!block || !flat || !email) {
        alert("Please fill all required fields (Block, Flat, Email)");
        return;
      }
      const donation = Number(donationEl.value) || 0;
      if (donation < 750) {
        alert("Minimum donation is ₹750");
        return;
      }
      const day1Tokens = Number(day1TokensEl.value) || 0;
      const day2Tokens = Number(day2TokensEl.value) || 0;
      if (day1Tokens + day2Tokens === 0) {
        alert("Please select at least one token for any day");
        return;
      }

      const flatNo = `${block}-${flat}`;
      const tokensSummary = generateTokensSummary(day1Tokens, day2Tokens);
      const total = donation + day1Tokens * DAY1_PRICE + day2Tokens * DAY2_PRICE;

      // Open payment app
      const upiLink = generateUpiLink(app, total.toFixed(2), flatNo, tokensSummary);
      qrFallbackDiv.style.display = "none";
      window.location.href = upiLink;

      // Show fallback QR if app not opening
      setTimeout(() => {
        qrFallbackDiv.style.display = "block";
        QRCode.toCanvas(qrCanvas, generateUpiLink(null, total.toFixed(2), flatNo, tokensSummary), function (error) {
          if (error) console.error(error);
        });
      }, 2000);
    }

    // Calculate total on input change
    donationEl.addEventListener("input", calculateTotal);
    day1TokensEl.addEventListener("input", calculateTotal);
    day2TokensEl.addEventListener("input", calculateTotal);

    payPhonePeBtn.addEventListener("click", () => handlePay("phonepe"));
    payGPayBtn.addEventListener("click", () => handlePay("gpay"));

    calculateTotal();

    // Form submit (send data to backend to generate and email tokens)
    document.getElementById("tokenForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const data = {
        block: blockEl.value,
        flat: flatEl.value,
        email: emailEl.value,
        donation: Number(donationEl.value),
        day1Tokens: Number(day1TokensEl.value),
        day2Tokens: Number(day2TokensEl.value),
      };

      // Validate minimums again
      if (!data.block || !data.flat || !data.email) {
        alert("Fill all required fields!");
        return;
      }
      if (data.donation < 750) {
        alert("Donation must be at least ₹750");
        return;
      }
      if (data.day1Tokens + data.day2Tokens === 0) {
        alert("Select at least one token");
        return;
      }

      try {
        const res = await fetch("/.netlify/functions/sendTokens", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        const json = await res.json();
        if (json.success) {
          alert("Tokens emailed successfully!");
        } else {
          alert("Error sending tokens: " + json.error);
        }
      } catch (err) {
        alert("Error: " + err.message);
      }
    });
</script>
</body>
</html>
